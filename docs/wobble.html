<h1>Wobble smoothing</h1>
<p>To reduce high frequency noise.</p>
<p><strong>Algorithm</strong>: Wobble smoothing<br />
<strong>Input</strong> :
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="true" form="prefix">{</mo><mrow><mo stretchy="true" form="prefix">(</mo><mi>x</mi><mo stretchy="false" form="prefix">[</mo><mi>k</mi><mo stretchy="false" form="postfix">]</mo><mo>,</mo><mi>y</mi><mo stretchy="false" form="prefix">[</mo><mi>k</mi><mo stretchy="false" form="postfix">]</mo><mo>,</mo><mi>t</mi><mo stretchy="false" form="prefix">[</mo><mi>k</mi><mo stretchy="false" form="postfix">]</mo><mo stretchy="true" form="postfix">)</mo></mrow><mo>âˆˆ</mo><msup><mi>â„</mi><mn>2</mn></msup><mo>Ã—</mo><msub><mi>â„</mi><mo>+</mo></msub><mo>,</mo><mn>0</mn><mo>â‰¤</mo><mi>k</mi><mo>â‰¤</mo><mi>n</mi><mo stretchy="true" form="postfix">}</mo></mrow><annotation encoding="application/x-tex">\left\{ \left( x\lbrack k\rbrack,y\lbrack k\rbrack,t\lbrack k\rbrack \right) \in {\mathbb{R}}^{2} \times {\mathbb{R}}_{+},0 \leq k \leq n \right\}</annotation></semantics></math>,
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>Î”</mi><mi>T</mi><mo>&gt;</mo><mn>0</mn></mrow><annotation encoding="application/x-tex">\Delta T &gt; 0</annotation></semantics></math>
(from <code>wobble_smoother_timeout</code>),
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>v</mi><mtext mathvariant="normal">min</mtext></msub><annotation encoding="application/x-tex">v_{\text{min}}</annotation></semantics></math>
(from <code>wobble_smoother_speed_floor</code>) and
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>v</mi><mtext mathvariant="normal">max</mtext></msub><annotation encoding="application/x-tex">v_{\text{max}}</annotation></semantics></math>
( from <code>wobble_smoother_speed_ceiling</code>)<br />
Compute a weighted moving average of the positions
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mover><mi>p</mi><mo accent="true">Â¯</mo></mover><mo stretchy="false" form="prefix">[</mo><mi>j</mi><mo stretchy="false" form="postfix">]</mo><mo>=</mo><mrow><mo stretchy="true" form="prefix">(</mo><mover><mi>x</mi><mo accent="true">Â¯</mo></mover><mo stretchy="false" form="prefix">[</mo><mi>j</mi><mo stretchy="false" form="postfix">]</mo><mo>,</mo><mover><mi>y</mi><mo accent="true">Â¯</mo></mover><mo stretchy="false" form="prefix">[</mo><mi>j</mi><mo stretchy="false" form="postfix">]</mo><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">\overline{p}\lbrack j\rbrack = \left( \overline{x}\lbrack j\rbrack,\overline{y}\lbrack j\rbrack \right)</annotation></semantics></math>
<math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>âˆ€</mo><mi>j</mi><mo>âˆˆ</mo><mo stretchy="false" form="prefix">âŸ¦</mo><mn>0</mn><mo>,</mo><mi>n</mi><mo stretchy="false" form="postfix">âŸ§</mo><mo>,</mo><mover><mi>p</mi><mo accent="true">Â¯</mo></mover><mo stretchy="false" form="prefix">[</mo><mi>j</mi><mo stretchy="false" form="postfix">]</mo><mo>=</mo><mrow><mo stretchy="true" form="prefix">{</mo><mtable><mtr><mtd columnalign="left" style="text-align: left"><mfrac><mrow><munderover><mo>âˆ‘</mo><mrow><mi>k</mi><mo>=</mo><mn>1</mn></mrow><mi>n</mi></munderover><mi>p</mi><mo stretchy="false" form="prefix">[</mo><mi>k</mi><mo stretchy="false" form="postfix">]</mo><mrow><mo stretchy="true" form="prefix">(</mo><mi>t</mi><mo stretchy="false" form="prefix">[</mo><mi>k</mi><mo stretchy="false" form="postfix">]</mo><mo>âˆ’</mo><mi>t</mi><mo stretchy="false" form="prefix">[</mo><mi>k</mi><mo>âˆ’</mo><mn>1</mn><mo stretchy="false" form="postfix">]</mo><mo stretchy="true" form="postfix">)</mo></mrow><msub><mn>ğŸ™</mn><mrow><mrow><mo stretchy="true" form="prefix">[</mo><mi>t</mi><mo stretchy="false" form="prefix">[</mo><mi>j</mi><mo stretchy="false" form="postfix">]</mo><mo>âˆ’</mo><mi>Î”</mi><mi>T</mi><mo>,</mo><mi>t</mi><mo stretchy="false" form="prefix">[</mo><mi>j</mi><mo stretchy="false" form="postfix">]</mo><mo stretchy="true" form="postfix">]</mo></mrow></mrow></msub><mrow><mo stretchy="true" form="prefix">(</mo><mi>t</mi><mo stretchy="false" form="prefix">[</mo><mi>k</mi><mo stretchy="false" form="postfix">]</mo><mo stretchy="true" form="postfix">)</mo></mrow></mrow><mrow><munderover><mo>âˆ‘</mo><mrow><mi>k</mi><mo>=</mo><mn>1</mn></mrow><mi>n</mi></munderover><msub><mn>ğŸ™</mn><mrow><mrow><mo stretchy="true" form="prefix">[</mo><mi>t</mi><mo stretchy="false" form="prefix">[</mo><mi>j</mi><mo stretchy="false" form="postfix">]</mo><mo>âˆ’</mo><mi>Î”</mi><mi>T</mi><mo>,</mo><mi>t</mi><mo stretchy="false" form="prefix">[</mo><mi>j</mi><mo stretchy="false" form="postfix">]</mo><mo stretchy="true" form="postfix">]</mo></mrow></mrow></msub><mrow><mo stretchy="true" form="prefix">(</mo><mi>t</mi><mo stretchy="false" form="prefix">[</mo><mi>k</mi><mo stretchy="false" form="postfix">]</mo><mo stretchy="true" form="postfix">)</mo></mrow></mrow></mfrac></mtd><mtd columnalign="left" style="text-align: left"><mrow><mtext mathvariant="normal">if the numerator </mtext><mspace width="0.333em"></mspace></mrow><mo>â‰ </mo><mn>0</mn></mtd></mtr><mtr><mtd columnalign="left" style="text-align: left"><mi>p</mi><mo stretchy="false" form="prefix">[</mo><mi>j</mi><mo stretchy="false" form="postfix">]</mo></mtd><mtd columnalign="left" style="text-align: left"><mtext mathvariant="normal">otherwise</mtext></mtd></mtr></mtable></mrow></mrow><annotation encoding="application/x-tex">\forall j \in âŸ¦0,nâŸ§,\overline{p}\lbrack j\rbrack = \begin{cases}
\frac{\sum_{k = 1}^{n}p\lbrack k\rbrack\left( t\lbrack k\rbrack - t\lbrack k - 1\rbrack \right)\mathbb{1}_{\left. \left\lbrack t\lbrack j\rbrack - \Delta T,t\lbrack j\rbrack \right\rbrack \right.}\left( t\lbrack k\rbrack \right)}{\sum_{k = 1}^{n}\mathbb{1}_{\left. \left\lbrack t\lbrack j\rbrack - \Delta T,t\lbrack j\rbrack \right\rbrack \right.}\left( t\lbrack k\rbrack \right)} &amp; \text{if the numerator } \neq 0 \\
p\lbrack j\rbrack &amp; \text{otherwise}
\end{cases}</annotation></semantics></math> Calculate a moving average
velocity
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mover><mi>v</mi><mo accent="true">Â¯</mo></mover><mo stretchy="false" form="prefix">[</mo><mi>j</mi><mo stretchy="false" form="postfix">]</mo></mrow><annotation encoding="application/x-tex">\overline{v}\lbrack j\rbrack</annotation></semantics></math>
<math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>âˆ€</mo><mi>j</mi><mo>âˆˆ</mo><mo stretchy="false" form="prefix">âŸ¦</mo><mn>0</mn><mo>,</mo><mi>n</mi><mo stretchy="false" form="postfix">âŸ§</mo><mo>,</mo><mover><mi>v</mi><mo accent="true">Â¯</mo></mover><mo stretchy="false" form="prefix">[</mo><mi>j</mi><mo stretchy="false" form="postfix">]</mo><mo>=</mo><mrow><mo stretchy="true" form="prefix">{</mo><mtable><mtr><mtd columnalign="left" style="text-align: left"><mn>0</mn></mtd><mtd columnalign="left" style="text-align: left"><mi>j</mi><mo>=</mo><mn>0</mn></mtd></mtr><mtr><mtd columnalign="left" style="text-align: left"><mfrac><mrow><munderover><mo>âˆ‘</mo><mrow><mi>k</mi><mo>=</mo><mn>1</mn></mrow><mi>n</mi></munderover><mrow><mo stretchy="true" form="prefix">âˆ¥</mo><mi>p</mi><mo stretchy="false" form="prefix">[</mo><mi>k</mi><mo stretchy="false" form="postfix">]</mo><mo>âˆ’</mo><mi>p</mi><mo stretchy="false" form="prefix">[</mo><mi>k</mi><mo>âˆ’</mo><mn>1</mn><mo stretchy="false" form="postfix">]</mo><mo stretchy="true" form="postfix">âˆ¥</mo></mrow><msub><mn>ğŸ™</mn><mrow><mrow><mo stretchy="true" form="prefix">[</mo><mi>t</mi><mo stretchy="false" form="prefix">[</mo><mi>j</mi><mo stretchy="false" form="postfix">]</mo><mo>âˆ’</mo><mi>Î”</mi><mi>T</mi><mo>,</mo><mi>t</mi><mo stretchy="false" form="prefix">[</mo><mi>j</mi><mo stretchy="false" form="postfix">]</mo><mo stretchy="true" form="postfix">]</mo></mrow></mrow></msub><mrow><mo stretchy="true" form="prefix">(</mo><mi>t</mi><mo stretchy="false" form="prefix">[</mo><mi>k</mi><mo stretchy="false" form="postfix">]</mo><mo stretchy="true" form="postfix">)</mo></mrow></mrow><mrow><munderover><mo>âˆ‘</mo><mrow><mi>k</mi><mo>=</mo><mn>1</mn></mrow><mi>n</mi></munderover><mrow><mo stretchy="true" form="prefix">(</mo><mi>t</mi><mo stretchy="false" form="prefix">[</mo><mi>k</mi><mo stretchy="false" form="postfix">]</mo><mo>âˆ’</mo><mi>t</mi><mo stretchy="false" form="prefix">[</mo><mi>k</mi><mo>âˆ’</mo><mn>1</mn><mo stretchy="false" form="postfix">]</mo><mo stretchy="true" form="postfix">)</mo></mrow><msub><mn>ğŸ™</mn><mrow><mrow><mo stretchy="true" form="prefix">[</mo><mi>t</mi><mo stretchy="false" form="prefix">[</mo><mi>j</mi><mo stretchy="false" form="postfix">]</mo><mo>âˆ’</mo><mi>Î”</mi><mi>T</mi><mo>,</mo><mi>t</mi><mo stretchy="false" form="prefix">[</mo><mi>j</mi><mo stretchy="false" form="postfix">]</mo><mo stretchy="true" form="postfix">]</mo></mrow></mrow></msub><mrow><mo stretchy="true" form="prefix">(</mo><mi>t</mi><mo stretchy="false" form="prefix">[</mo><mi>k</mi><mo stretchy="false" form="postfix">]</mo><mo stretchy="true" form="postfix">)</mo></mrow></mrow></mfrac><mspace width="1.0em"></mspace></mtd><mtd columnalign="left" style="text-align: left"><mtext mathvariant="normal">otherwise</mtext></mtd></mtr></mtable></mrow></mrow><annotation encoding="application/x-tex">\forall j \in âŸ¦0,nâŸ§,\overline{v}\lbrack j\rbrack = \begin{cases}
0 &amp; j = 0 \\
\frac{\sum_{k = 1}^{n}\left\| {p\lbrack k\rbrack - p\lbrack k - 1\rbrack} \right\|\mathbb{1}_{\left. \left\lbrack t\lbrack j\rbrack - \Delta T,t\lbrack j\rbrack \right\rbrack \right.}\left( t\lbrack k\rbrack \right)}{\sum_{k = 1}^{n}\left( t\lbrack k\rbrack - t\lbrack k - 1\rbrack \right)\mathbb{1}_{\left. \left\lbrack t\lbrack j\rbrack - \Delta T,t\lbrack j\rbrack \right\rbrack \right.}\left( t\lbrack k\rbrack \right)}\quad &amp; \text{otherwise}
\end{cases}</annotation></semantics></math> Interpolate between the
average position and the raw ones based on the average speed
<math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mtable><mtr><mtd columnalign="right" style="text-align: right"><mo>âˆ€</mo><mi>j</mi><mo>âˆˆ</mo><mo stretchy="false" form="prefix">âŸ¦</mo><mn>0</mn><mo>,</mo><mi>n</mi><mo stretchy="false" form="postfix">âŸ§</mo><mo>,</mo><mi>p</mi><mi>â€²</mi><mo stretchy="false" form="prefix">[</mo><mi>j</mi><mo stretchy="false" form="postfix">]</mo><mo>=</mo></mtd><mtd columnalign="left" style="text-align: left"><mo>min</mo><mrow><mo stretchy="true" form="prefix">(</mo><mfrac><mrow><mover><mi>v</mi><mo accent="true">Â¯</mo></mover><mo stretchy="false" form="prefix">[</mo><mi>j</mi><mo stretchy="false" form="postfix">]</mo><mo>âˆ’</mo><msub><mi>v</mi><mtext mathvariant="normal">min</mtext></msub></mrow><mrow><msub><mi>v</mi><mrow><mtext mathvariant="normal">max </mtext><mspace width="0.333em"></mspace></mrow></msub><mo>âˆ’</mo><msub><mi>v</mi><mtext mathvariant="normal">min</mtext></msub></mrow></mfrac><msub><mn>ğŸ™</mn><mrow><mo stretchy="false" form="prefix">[</mo><msub><mi>v</mi><mtext mathvariant="normal">min</mtext></msub><mo>,</mo><mi>âˆ</mi><mo stretchy="false" form="prefix">[</mo></mrow></msub><mrow><mo stretchy="true" form="prefix">(</mo><mover><mi>v</mi><mo accent="true">Â¯</mo></mover><mo stretchy="false" form="prefix">[</mo><mi>j</mi><mo stretchy="false" form="postfix">]</mo><mo stretchy="true" form="postfix">)</mo></mrow><mo>,</mo><mn>1</mn><mo stretchy="true" form="postfix">)</mo></mrow><mover><mi>p</mi><mo accent="true">Â¯</mo></mover><mo stretchy="false" form="prefix">[</mo><mi>j</mi><mo stretchy="false" form="postfix">]</mo></mtd></mtr><mtr><mtd columnalign="right" style="text-align: right"><mi>+</mi></mtd><mtd columnalign="left" style="text-align: left"><mrow><mo stretchy="true" form="prefix">(</mo><mn>1</mn><mo>âˆ’</mo><mo>min</mo><mrow><mo stretchy="true" form="prefix">(</mo><mfrac><mrow><mover><mi>v</mi><mo accent="true">Â¯</mo></mover><mo stretchy="false" form="prefix">[</mo><mi>j</mi><mo stretchy="false" form="postfix">]</mo><mo>âˆ’</mo><msub><mi>v</mi><mtext mathvariant="normal">min</mtext></msub></mrow><mrow><msub><mi>v</mi><mrow><mtext mathvariant="normal">max </mtext><mspace width="0.333em"></mspace></mrow></msub><mo>âˆ’</mo><msub><mi>v</mi><mtext mathvariant="normal">min</mtext></msub></mrow></mfrac><msub><mn>ğŸ™</mn><mrow><mo stretchy="false" form="prefix">[</mo><msub><mi>v</mi><mtext mathvariant="normal">min</mtext></msub><mo>,</mo><mi>âˆ</mi><mo stretchy="false" form="prefix">[</mo></mrow></msub><mrow><mo stretchy="true" form="prefix">(</mo><mover><mi>v</mi><mo accent="true">Â¯</mo></mover><mo stretchy="false" form="prefix">[</mo><mi>j</mi><mo stretchy="false" form="postfix">]</mo><mo stretchy="true" form="postfix">)</mo></mrow><mo stretchy="true" form="postfix">)</mo></mrow><mo stretchy="true" form="postfix">)</mo></mrow><mi>p</mi><mo stretchy="false" form="prefix">[</mo><mi>j</mi><mo stretchy="false" form="postfix">]</mo></mtd></mtr></mtable><annotation encoding="application/x-tex">\begin{aligned}
\forall j \in âŸ¦0,nâŸ§,p\prime\lbrack j\rbrack = &amp; \min(\frac{\overline{v}\lbrack j\rbrack - v_{\text{min}}}{v_{\text{max }} - v_{\text{min}}}\mathbb{1}_{\lbrack v_{\text{min}},\infty\lbrack}\left( \overline{v}\lbrack j\rbrack \right),1)\overline{p}\lbrack j\rbrack \\
 + &amp; \left( 1 - \min(\frac{\overline{v}\lbrack j\rbrack - v_{\text{min}}}{v_{\text{max }} - v_{\text{min}}}\mathbb{1}_{\lbrack v_{\text{min}},\infty\lbrack}\left( \overline{v}\lbrack j\rbrack \right)) \right)p\lbrack j\rbrack
\end{aligned}</annotation></semantics></math> where
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>p</mi><mi>â€²</mi><mo stretchy="false" form="prefix">[</mo><mi>j</mi><mo stretchy="false" form="postfix">]</mo><mo>=</mo><mrow><mo stretchy="true" form="prefix">(</mo><mi>x</mi><mi>â€²</mi><mo stretchy="false" form="prefix">[</mo><mi>j</mi><mo stretchy="false" form="postfix">]</mo><mo>,</mo><mi>y</mi><mi>â€²</mi><mo stretchy="false" form="prefix">[</mo><mi>j</mi><mo stretchy="false" form="postfix">]</mo><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">p\prime\lbrack j\rbrack = \left( x\prime\lbrack j\rbrack,y\prime\lbrack j\rbrack \right)</annotation></semantics></math><br />
<strong>Output</strong>:
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="true" form="prefix">{</mo><mrow><mo stretchy="true" form="prefix">(</mo><mi>x</mi><mi>â€²</mi><mo stretchy="false" form="prefix">[</mo><mi>k</mi><mo stretchy="false" form="postfix">]</mo><mo>,</mo><mi>y</mi><mi>â€²</mi><mo stretchy="false" form="prefix">[</mo><mi>k</mi><mo stretchy="false" form="postfix">]</mo><mo stretchy="true" form="postfix">)</mo></mrow><mo>âˆˆ</mo><msup><mi>â„</mi><mn>2</mn></msup><mo>,</mo><mn>0</mn><mo>â‰¤</mo><mi>k</mi><mo>â‰¤</mo><mi>n</mi><mo stretchy="true" form="postfix">}</mo></mrow><annotation encoding="application/x-tex">\left\{ \left( x\prime\lbrack k\rbrack,y\prime\lbrack k\rbrack \right) \in {\mathbb{R}}^{2},0 \leq k \leq n \right\}</annotation></semantics></math>
the filtered positions.<br />
Hence for low local speeds, the smoothing is maximum (we take exactly
the average position over the time
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>Î”</mi><mi>T</mi></mrow><annotation encoding="application/x-tex">\Delta T</annotation></semantics></math>)
and for high speed there is no smoothing. We also note that the first
position is thus never filtered.</p>
